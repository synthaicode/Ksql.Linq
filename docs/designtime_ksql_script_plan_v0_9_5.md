# Ksql.Linq v0.9.5 実装計画: デザイン時 KSQL 出力

## 1. ゴールとスコープ

- Kafka / ksqlDB が未起動でも、`KsqlContext` から **全 KSQL スクリプト（DDL/CSAS/CTAS/SELECT）を一括生成**できること。
- アプリ本体の起動シーケンスや外部設定・接続と切り離し、**ビルド済み DLL + Reflection だけでモデルをインスペクション**できること。
- EF Core の `IDesignTimeDbContextFactory` と同様に、**デザイン時専用の `KsqlContext` 生成パス**を提供すること。

非スコープ:

- ランタイム時の `KsqlContext` 挙動変更（起動シーケンス、Kafka 接続ロジックの仕様変更など）は行わない。
- Kafka / ksqlDB への実行・適用は含めず、「スクリプト生成」までを対象とする。

---

## 2. コア API 設計

### 2-1. デザイン時コンテキストファクトリ `IDesignTimeKsqlContextFactory`

目的:

- アプリを起動せず、外部設定や Kafka 接続に依存せずに `KsqlContext` モデルだけを構築するための「デザイン時エントリポイント」を提供する。

インターフェース案:

```csharp
namespace Kafka.Ksql.Linq
{
    public interface IDesignTimeKsqlContextFactory
    {
        KsqlContext CreateDesignTimeContext();
    }
}
```

想定利用者コード:

```csharp
public sealed class MyKsqlContextFactory : IDesignTimeKsqlContextFactory
{
    public KsqlContext CreateDesignTimeContext()
        => new MyKsqlContext(enableConnection: false);
}
```

設計ポイント:

- Factory 実装クラスはアプリ側アセンブリ（例: `MyProject`）に配置する。
- `CreateDesignTimeContext` 内では、**接続試行や設定ファイル読み込みを最小化**したコンストラクタ経路を利用する。
- ライブラリ側で必要であれば、`KsqlContext` に「デザイン時/非接続」用オプションやコンストラクタオーバーロードを追加する。

### 2-2. KSQL Script Builder API

目的:

- 既存のログ出力に散在している KSQL 組み立てロジックを集約し、**CLI からも再利用可能な正式 API** として公開する。

インターフェース案:

```csharp
namespace Kafka.Ksql.Linq
{
    public interface IKsqlScriptBuilder
    {
        KsqlScript Build(KsqlContext context);
    }

    public sealed class KsqlScript
    {
        public IReadOnlyList<string> Statements { get; }

        public string ToSql();
    }
}
```

設計ポイント:

- `Statements` には `CREATE STREAM/TABLE`, `CSAS/CTAS`, `SELECT` 等を **依存関係順に並べた KSQL 文**を格納する。
- `ToSql()` は `Statements` を適切な区切り（例: `";\n\n"`）で連結したテキストを返す。
- 既存 `KsqlContext` 内で KSQL を構成している箇所を可能な限り Script Builder に移譲し、ロジックの二重実装を避ける。

---

## 3. CLI / ツール構成と Reflection ローディング

### 3-1. CLI ツール概要

目的:

- ユーザーが `.NET CLI` 経由で **ビルド済みアセンブリからデザイン時 `KsqlContext` を生成し、KSQL スクリプトを一括出力**できるようにする。

ツール案:

- プロジェクト: `Ksql.Linq.Tools`（仮称）
- 配布形態: `.NET` グローバル/ローカルツール
- コマンド例: `dotnet ksql script --context MyKsqlContext`

代表的な利用例:

```bash
dotnet ksql script ^
  --project ./src/MyApp/MyApp.csproj ^
  --context MyKsqlContext ^
  --output ./ksql/generated.sql
```

### 3-2. 実行フロー

1. `--project` で指定されたプロジェクトを `dotnet build` し、ターゲット DLL を取得する。  
2. `AssemblyLoadContext` 等でアセンブリをロードする。  
3. ロードしたアセンブリ内から `IDesignTimeKsqlContextFactory` 実装クラスを探索する。  
4. Factory インスタンスを生成し、`CreateDesignTimeContext()` を呼び出して `KsqlContext` を得る。  
5. ライブラリの `IKsqlScriptBuilder.Build(context)` を用いて `KsqlScript` を生成する。  
6. `KsqlScript.ToSql()` の結果を標準出力または `--output` ファイルに書き込む。  

設計ポイント:

- アプリ本体の `Program` やホスト起動ロジックは一切呼び出さない。
- `IDesignTimeKsqlContextFactory` が複数見つかった場合の扱い（エラー/明示指定）を設計する。
- 初期段階では `script` サブコマンドのみをサポートし、将来的に `info` 等の補助コマンドを追加可能とする。

---

## 4. バージョン印とトレーサビリティ

### 4-1. スクリプトヘッダ仕様

目的:

- 「この KSQL はどのソース/バージョンから生成されたか」を明確にし、**古いスクリプトの誤適用を防ぐ**。

ヘッダ例:

```sql
-- Generated by Ksql.Linq 0.9.5
-- Assembly: MyProject 1.2.3.0
-- GeneratedAt: 2025-11-18T07:21:00+09:00
```

設計ポイント:

- `Ksql.Linq` のバージョンは `typeof(KsqlContext).Assembly.GetName().Version` 等から取得する。
- 対象アセンブリ名/バージョンは、ロードしたユーザーアセンブリの `AssemblyName` から取得する。
- 時刻は ISO 8601 形式（タイムゾーン付き）で出力する。
- ヘッダ生成は Script Builder または CLI 側のどちらかに集約し、責務を明確にする。

---

## 5. 実装フェーズとマイルストーン

### M1. コア API 追加

- `IDesignTimeKsqlContextFactory` インターフェースの追加。
- `IKsqlScriptBuilder` および `KsqlScript` 型の追加。
- 既存の KSQL 組み立てロジックを `IKsqlScriptBuilder` 実装に移譲する。

成果物:

- `KsqlContext` を用いてプログラム内から `KsqlScript` を取得し、一括 SQL を生成できる。

### M2. CLI / ツール プロトタイプ

- `Ksql.Linq.Tools` プロジェクトの作成。
- `dotnet ksql script` 相当のコマンドと引数パーシングを実装。
- DLL ロード、Factory 検出、`KsqlContext` 生成、`KsqlScript` 生成〜出力までの一連のフローを構築。

成果物:

- ローカル環境で `dotnet ksql script --project ... --context ...` を実行し、KSQL スクリプトをファイル/標準出力に出せる。

### M3. バージョン印と出力オプション

- スクリプトヘッダに `Ksql.Linq` バージョン、対象アセンブリ名/バージョン、生成日時を埋め込む。
- `--output` 等の出力先指定オプションを整備。
- 必要に応じて、整形オプション（例: 改行、セミコロン終端など）を検討。

成果物:

- スクリプトと元アセンブリの対応関係が一意に追跡可能な状態。

### M4. ドキュメントとサンプル更新

- ルート `README.md` および `src/README.md` に「デザイン時 KSQL 出力」機能の概要と使い方を追加。
- サンプルプロジェクトに `MyKsqlContextFactory` 実装例と `dotnet ksql script` 実行例を追加。

成果物:

- OSS 利用者がガイドを読めば、Kafka / ksqlDB を立ち上げずに KSQL スクリプトを生成できる状態。

---

## 6. 今後の拡張余地（メモ）

- `dotnet ef` ライクなサブコマンド群（例: `dotnet ksql context info`）の追加。
- CI での KSQL スナップショット生成と差分比較ワークフローへの統合。
- マルチコンテキスト/マルチアセンブリ対応や、環境ごとのスキーマ差分チェック機能など。

