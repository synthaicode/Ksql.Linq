name: PR Validate (Public API + Examples)

on:
  pull_request:
    branches:
      - main
      - release/**

concurrency:
  group: pr-validate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Verify AI_ASSISTANT_GUIDE.md matches sources
        shell: pwsh
        run: |
          pwsh -NoLogo -File tools/build-ai-assistant-guide.ps1 -Verify

      - name: Verify library/CLI versions are aligned
        shell: pwsh
        run: |
          function Get-Version([string]$path) {
            $xml = Get-Content $path -Raw
            $m = [regex]::Match($xml, '<Version>([^<]+)</Version>')
            if (-not $m.Success) { throw "Missing <Version> in $path" }
            return $m.Groups[1].Value
          }
          $lib = Get-Version 'src/Ksql.Linq.csproj'
          $cli = Get-Version 'src/Ksql.Linq.Cli/Ksql.Linq.Cli.csproj'
          if ($lib -ne $cli) {
            throw "Version mismatch: library=$lib cli=$cli. Keep src/Ksql.Linq.csproj and src/Ksql.Linq.Cli/Ksql.Linq.Cli.csproj in sync."
          }
          Write-Host "[version] OK: library=$lib cli=$cli"

      - name: Build library (Public API checks not enforced in PR)
        run: |
          dotnet build src/Ksql.Linq.csproj -c Release --no-incremental --nologo

      - name: Compute package version
        id: ver
        shell: pwsh
        run: |
          $xml = Get-Content src/Ksql.Linq.csproj -Raw
          $base = ([regex]::Match($xml, '<Version>([^<]+)</Version>')).Groups[1].Value
          $pkg = "$base-pr.${{ github.run_number }}"
          "pkg=$pkg" >> $env:GITHUB_OUTPUT

      - name: Pack local preview (PR)
        run: |
          dotnet pack src/Ksql.Linq.csproj -c Release -o ./.artifacts/nuget \
            -p:IncludeSymbols=true -p:SymbolPackageFormat=snupkg \
            -p:PackageVersion=${{ steps.ver.outputs.pkg }}

      - name: Verify AI_ASSISTANT_GUIDE.md is packaged (library)
        shell: pwsh
        run: |
          $nupkg = Get-ChildItem ./.artifacts/nuget -Filter 'Ksql.Linq.*.nupkg' | Select-Object -First 1
          if (-not $nupkg) { throw "No library nupkg found under .artifacts/nuget" }
          Add-Type -AssemblyName System.IO.Compression
          $zip = [System.IO.Compression.ZipFile]::OpenRead($nupkg.FullName)
          try {
            $entry = $zip.Entries | Where-Object { $_.FullName -ieq 'AI_ASSISTANT_GUIDE.md' } | Select-Object -First 1
            if (-not $entry) { throw "AI_ASSISTANT_GUIDE.md is missing from $($nupkg.Name)" }
            if ($entry.Length -lt 1000) { throw "AI_ASSISTANT_GUIDE.md seems too small ($($entry.Length) bytes) in $($nupkg.Name)" }
            Write-Host "[ai-guide] OK: packaged AI_ASSISTANT_GUIDE.md ($($entry.Length) bytes)"
          }
          finally { $zip.Dispose() }

      - name: Point examples to local package version
        shell: pwsh
        run: |
          $ver='${{ steps.ver.outputs.pkg }}'
          $p = 'examples/Directory.Build.props'
          [xml]$doc = Get-Content $p -Raw
          $proj = $doc.Project
          if (-not $proj) { throw "Invalid MSBuild props: missing <Project> root in $p" }
          $pkgRef = $null
          if ($proj.ItemGroup) {
            foreach ($ig in $proj.ItemGroup) {
              foreach ($pr in ($ig.PackageReference)) {
                if ($pr.Include -eq 'Ksql.Linq') { $pkgRef = $pr; break }
              }
              if ($pkgRef) { break }
            }
          }
          if (-not $pkgRef) {
            $ig = $doc.CreateElement('ItemGroup')
            $pkgRef = $doc.CreateElement('PackageReference')
            $pkgRef.SetAttribute('Include','Ksql.Linq') | Out-Null
            $pkgRef.SetAttribute('Version', $ver) | Out-Null
            $ig.AppendChild($pkgRef) | Out-Null
            $proj.AppendChild($ig) | Out-Null
          } else {
            $pkgRef.SetAttribute('Version', $ver) | Out-Null
          }
          $doc.Save($p)
      - name: Create NuGet config
        run: |
          cat > nuget.config <<EOF
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <packageSources>
              <clear />
              <add key="nuget.org" value="https://api.nuget.org/v3/index.json" protocolVersion="3" />
              <add key="local" value=".artifacts/nuget" />
            </packageSources>
          </configuration>
          EOF
      - name: Build examples
        run: |
          for proj in $(find examples -name '*.csproj'); do
            echo "Building $proj"
            dotnet restore "$proj" --source https://api.nuget.org/v3/index.json --source "${{ github.workspace }}/.artifacts/nuget"
            dotnet build "$proj" --no-restore
          done
