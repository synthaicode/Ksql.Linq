name: PR Validate (Public API + Examples)

on:
  pull_request:
    branches:
      - main
      - release/**

concurrency:
  group: pr-validate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Build library (Public API checks not enforced in PR)
        run: |
          dotnet build src/Ksql.Linq.csproj -c Release --no-incremental --nologo

      - name: Compute package version
        id: ver
        shell: pwsh
        run: |
          $xml = Get-Content src/Ksql.Linq.csproj -Raw
          $base = ([regex]::Match($xml, '<Version>([^<]+)</Version>')).Groups[1].Value
          $pkg = "$base-pr.${{ github.run_number }}"
          "pkg=$pkg" >> $env:GITHUB_OUTPUT

      - name: Pack local preview (PR)
        run: |
          dotnet pack src/Ksql.Linq.csproj -c Release -o ./.artifacts/nuget \
            -p:IncludeSymbols=true -p:SymbolPackageFormat=snupkg \
            -p:PackageVersion=${{ steps.ver.outputs.pkg }}

      - name: Point examples to local package version
        shell: pwsh
        run: |
          $ver='${{ steps.ver.outputs.pkg }}'
          $p = 'examples/Directory.Build.props'
          [xml]$doc = Get-Content $p -Raw
          $proj = $doc.Project
          if (-not $proj) { throw "Invalid MSBuild props: missing <Project> root in $p" }
          $pkgRef = $null
          if ($proj.ItemGroup) {
            foreach ($ig in $proj.ItemGroup) {
              foreach ($pr in ($ig.PackageReference)) {
                if ($pr.Include -eq 'Ksql.Linq') { $pkgRef = $pr; break }
              }
              if ($pkgRef) { break }
            }
          }
          if (-not $pkgRef) {
            $ig = $doc.CreateElement('ItemGroup')
            $pkgRef = $doc.CreateElement('PackageReference')
            $pkgRef.SetAttribute('Include','Ksql.Linq') | Out-Null
            $pkgRef.SetAttribute('Version', $ver) | Out-Null
            $ig.AppendChild($pkgRef) | Out-Null
            $proj.AppendChild($ig) | Out-Null
          } else {
            $pkgRef.SetAttribute('Version', $ver) | Out-Null
          }
          $doc.Save($p)
      - name: Build examples
        run: |
          for proj in $(find examples -name '*.csproj'); do
            echo "Building $proj"
            dotnet restore "$proj" --source https://api.nuget.org/v3/index.json --source .artifacts/nuget
            dotnet build "$proj" --no-restore
          done
